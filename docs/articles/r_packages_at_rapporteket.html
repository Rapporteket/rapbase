<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introducing R packages at Rapporteket • rapbase</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introducing R packages at Rapporteket">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rapbase</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.8.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/dealing_with_dates.html">Registerdata, R og bruk av dato</a>
    </li>
    <li>
      <a href="../articles/r_packages_at_rapporteket.html">Introducing R packages at Rapporteket</a>
    </li>
    <li>
      <a href="../articles/technical_knowhow_at_rapporteket.html">Technical knowhow at Rapporteket</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/Rapporteket/rapbase">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Introducing R packages at Rapporteket</h1>
                        <h4 class="author">Are Edvardsen</h4>
            
            <h4 class="date">2019-07-12</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/Rapporteket/rapbase/blob/master/vignettes/r_packages_at_rapporteket.Rmd"><code>vignettes/r_packages_at_rapporteket.Rmd</code></a></small>
      <div class="hidden name"><code>r_packages_at_rapporteket.Rmd</code></div>

    </div>

    
    
<p>Hoepfully, use of R packages will make both development and system meintenance at Rappporteket easier. However, this calls for some changes of both routines and configuration/set-up. In the following, such changes are logged as they are made. Hence, all entries here should be reviewed before an approval of this approach.</p>
<div id="user-privileges" class="section level2">
<h2 class="hasAnchor">
<a href="#user-privileges" class="anchor"></a>User privileges</h2>
<p>Intallation of packages must also work automated. In a manual approach operating with root privileges is common and trivial. However, processes either automated or initiated by random users or external triggers should always be run with very reduced privileges. At <em>Rapporteket</em> all R related processes are run by the unprivileged user <em>tomcat</em>. This should the also apply to handling of R packages.</p>
<p>During installation of R packages R checks the privileges of the user who triggers the installation. If the user has root privileges, the package is installed alongside the rest of the (default) packages providing system wide access. If the user does not have root privileges the package will be installed in the users home directory and will thus only be available to that praticular user.</p>
<p>The <em>tomcat</em> user does not even have his own home directory suitable for install of R packages. Hence, a local R package site library is proposed where <em>tomcat</em> have read and write access. By default, an R install comes with built in definition of several options, and at Rapporteket these are:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.getenv">Sys.getenv</a></span>(<span class="st">"R_LIBS_SITE"</span>)
[<span class="dv">1</span>] <span class="st">"/usr/local/lib/R/site-library:/usr/local/lib/R/library:</span>
<span class="st">/usr/lib64/R/library:/usr/share/R/library"</span></code></pre></div>
<p>The only one that actually exists is <em>/usr/lib64/R/library</em> and packages installed as root are all placed here. User <em>tomcat</em> does not have write access to this directory and cannot install any packages.</p>
<p>To enable user <em>tomcat</em> to install our own packages it is proposed to use on of the other options, by (as root) creating directories and setting appropriate privileges:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="bu">cd</span> /usr/local/lib
<span class="fu">mkdir</span> -p R/site-library
<span class="fu">chown</span> -R root:tomcat R
<span class="fu">chmod</span> -R ug+rwx R</code></pre></div>
<p>Now, also user <em>tomcat</em> will be able to install packages<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a>.</p>
<p>All R sessions are spawned by Rserve which need some additional information, also on the library paths to use. Hence, the startup script for Rserve must be extended by defining and exporting an additional environmental varaible R_LIBS:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="va">R_LIBS=</span>/usr/lib64/R/library:/usr/local/lib/R/site-library
<span class="bu">export</span> <span class="va">R_LIBS</span></code></pre></div>
<p>The above two lines must hence be added to the Rserve start-up script (<em>/etc/init.d/rserve</em>).</p>
</div>
<div id="installing-our-own-packages-from-github" class="section level2">
<h2 class="hasAnchor">
<a href="#installing-our-own-packages-from-github" class="anchor"></a>Installing our own packages from github</h2>
<p>We aim to distribute all R related reports as standard R package infrastructure. These packages will all be hosted by github then acting as a common repository for both development and installation.</p>
<p>Our packages will have dependencies to other packages found in the official R repositories. All dependencies must be accessible upon installation of our packages. All request from <em>Rapporteket</em> to external resources will have to use a proxy server which have to be defined:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.setenv">Sys.setenv</a></span>(<span class="dt">http_proxy=</span><span class="st">"http://www-proxy-rn.helsenord.no:8080"</span>)</code></pre></div>
<p>Communication with github requires TLS (https/ssl) so we need an additional library and some configuration to make this work:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(httr)
<span class="kw"><a href="https://www.rdocumentation.org/packages/httr/topics/set_config">set_config</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/httr/topics/use_proxy">use_proxy</a></span>(<span class="dt">url=</span><span class="st">"172.29.3.232"</span>, <span class="dt">port=</span><span class="dv">8080</span>))</code></pre></div>
<p>The actual installation can then be performed using the <em>devtools</em> package, the following being relevant for a TEST or QA environment:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">devtools<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/devtools/topics/reexports">install_github</a></span>(<span class="st">"Rapporteket/rapbase"</span>, <span class="dt">ref =</span> <span class="st">"rel"</span>, <span class="dt">args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"--clean"</span>))</code></pre></div>
<p>For a PRODUCTION environment the following should be used:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">devtools<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/devtools/topics/reexports">install_github</a></span>(<span class="st">"Rapporteket/rapbase"</span>, <span class="dt">ref =</span> <span class="st">"master"</span>, <span class="dt">args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"--clean"</span>))</code></pre></div>
</div>
<div id="troubleshooting" class="section level2">
<h2 class="hasAnchor">
<a href="#troubleshooting" class="anchor"></a>Troubleshooting</h2>
<p>Things may go wrong, awfully so. Misery collected:</p>
<div id="proxy-and-tls" class="section level3">
<h3 class="hasAnchor">
<a href="#proxy-and-tls" class="anchor"></a>Proxy and TLS</h3>
<p>Observed: packages (primarily our own) will not intstall because they depend on other CRAN packages that cannot be installed.</p>
<p>Plausible cause: network communication with (CRAN) https mirrors fails, time-out or stops due to internal proxies.</p>
<p>Solution: manually install dependency packages and selecting http mirrors which may be an (last) option in the list of https mirrors.</p>
</div>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>An alternative approch will be to create a proper HOME for user <em>tomcat</em><a href="#fnref1">↩</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#user-privileges">User privileges</a></li>
      <li><a href="#installing-our-own-packages-from-github">Installing our own packages from github</a></li>
      <li><a href="#troubleshooting">Troubleshooting</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Edvardsen Are, Thon Kevin.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
