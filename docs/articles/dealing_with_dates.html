<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Registerdata, R og bruk av dato • rapbase</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Registerdata, R og bruk av dato">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rapbase</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.8.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/dealing_with_dates.html">Registerdata, R og bruk av dato</a>
    </li>
    <li>
      <a href="../articles/r_packages_at_rapporteket.html">Introducing R packages at Rapporteket</a>
    </li>
    <li>
      <a href="../articles/technical_knowhow_at_rapporteket.html">Technical knowhow at Rapporteket</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/Rapporteket/rapbase">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Registerdata, R og bruk av dato</h1>
                        <h4 class="author">Are Edvardsen, SKDE</h4>
            
            <h4 class="date">2019-07-12</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/Rapporteket/rapbase/blob/master/vignettes/dealing_with_dates.Rmd"><code>vignettes/dealing_with_dates.Rmd</code></a></small>
      <div class="hidden name"><code>dealing_with_dates.Rmd</code></div>

    </div>

    
    
<div id="problembeskrivelse" class="section level2">
<h2 class="hasAnchor">
<a href="#problembeskrivelse" class="anchor"></a>Problembeskrivelse</h2>
<p>Vanlig arbeidsflyt i framstilling av registerinformasjon på ved bruk av R på Rapporteket består forenklet av 1) å spørre om data fra en database, 2) gjøre talloperasjoner og 3) presentere resultatet i form av tabeller, figurer og tekst. I registerdata vil det bestandig finnes ulike former for tidsinformasjon slik som dato og klokkeslett. Følgelig er det da også normalt å måtte forholde seg til tid i de talloperasjoner som gjøres underveis fram til et ferdig resultat. I R er det mange pakker og enda flere funksjoner som er aktuelle for bruk på tidsvariabler. Felles for slike “kalender-funksjoner”" er at det ofte kan være vanskelig å få full oversikt og forståelse av hvordan de virker. I praktisk bruk forsøker man gjerne flere varianter til man har noe som synes å gi et tilforlatelig svar. Slik tilnærming vil gi en større risiko for feil. Ved bruk av et konkret eksempel er det her gjort et forsøk på redegjøre for noen vanlig brukte kalenderfunksjoner slik at at risiko for feil ved framtidig bruk reduseres.</p>
</div>
<div id="eksempel-pa-feil-som-oppstar" class="section level2">
<h2 class="hasAnchor">
<a href="#eksempel-pa-feil-som-oppstar" class="anchor"></a>Eksempel på feil som oppstår</h2>
<p>Følgende eksempel gir en reell reproduksjon av <a href="https://github.com/Rapporteket/norgast/issues/2">feil oppdaget i <em>NorGAst</em></a> der endepunktet i datoutvalget ikke kommer med i analysen. Kommandoene under er kjørt på <em>Rapporteket</em> TEST. Av hensyn til forenkling er det bare benyttet en øvre (<em>datoTil</em>) og ingen nedre (<em>datoFra</em>) begrensning av dato.</p>
<p>Angi register, databasemotor og sluttdato:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">registryName &lt;-<span class="st"> "norgast"</span>
dbType &lt;-<span class="st"> "mysql"</span>
datoTil &lt;-<span class="st"> "2017-07-31"</span></code></pre></div>
<p>Lag databasespørring:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">query &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"SELECT</span>
<span class="st">                   OpDato</span>
<span class="st">                 FROM</span>
<span class="st">                   AlleVariablerNum</span>
<span class="st">                 WHERE</span>
<span class="st">                   opDato &lt;= </span><span class="ch">\'</span><span class="st">"</span>, datoTil, <span class="st">"'"</span>)</code></pre></div>
<p>Hent data:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">RegData &lt;-<span class="st"> </span>rapbase<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/rapbase/topics/LoadRegData">LoadRegData</a></span>(registryName, query, dbType)</code></pre></div>
<p>Lag ny variabel <em>OperasjonsDato</em> slik det er gjort i <em>NorGAst</em>, sjekk maxverdi og klasse på opprinnelig og ny variabel:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">RegData<span class="op">$</span>OperasjonsDato &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.POSIXlt">as.POSIXlt</a></span>(RegData<span class="op">$</span>OpDato, <span class="dt">format=</span><span class="st">"%Y-%m-%d"</span>)

<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(RegData<span class="op">$</span>OpDato)
[<span class="dv">1</span>] <span class="st">"2017-07-31"</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/class">class</a></span>(RegData<span class="op">$</span>OpDato)
[<span class="dv">1</span>] <span class="st">"Date"</span>

<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(RegData<span class="op">$</span>OperasjonsDato)
[<span class="dv">1</span>] <span class="st">"2017-07-31 UTC"</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/class">class</a></span>(RegData<span class="op">$</span>OperasjonsDato)
[<span class="dv">1</span>] <span class="st">"POSIXlt"</span> <span class="st">"POSIXt"</span></code></pre></div>
<p>Maksimumsverdi stemmer med den som er oppgitt i spørringen. Legg merke til at opprinnelig variabel er av klassen <a href="http://stat.ethz.ch/R-manual/R-devel/library/base/html/Dates.html"><em>Date</em></a> og at tidssone ikke er angitt. Ved konvertering til klassen <a href="https://stat.ethz.ch/R-manual/R-devel/library/base/html/DateTimeClasses.html"><em>POSIXlt</em></a> benyttes default tidssone UTC.</p>
<p>Det neste som skjer i <em>NorGAst</em> er en (ekstra) filtrering på angitt datobegrensning:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">indDato &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/which">which</a></span>(RegData<span class="op">$</span>OperasjonsDato <span class="op">&lt;=</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.POSIXlt">as.POSIXlt</a></span>(datoTil))

<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(RegData<span class="op">$</span>OperasjonsDato)
[<span class="dv">1</span>] <span class="dv">14574</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(indDato)
[<span class="dv">1</span>] <span class="dv">14554</span>

<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(RegData<span class="op">$</span>OperasjonsDato[indDato])
[<span class="dv">1</span>] <span class="st">"2017-07-30 UTC"</span></code></pre></div>
<p>Selv om datobegrensningen er den samme som i opprinnelig spørring mot databasen (og at man da forventer at ingen verdier filtreres ut) så tas det i dette tilfellet likevel vekk 20 observasjoner (som alle har <em>OperasjonsDato</em> lik 2017-07-31). Årsaken ligger i ulik tidssone for de verdier som sammenholdes i filteret over:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.POSIXlt">as.POSIXlt</a></span>(datoTil)
[<span class="dv">1</span>] <span class="st">"2017-07-31 CEST"</span></code></pre></div>
<p>CEST (Central European Summer Time) ligger to timer foran UTC og siden tidsinformasjonen som benyttes bare inneholder dato (og ikke klokkeslett) så filtreres disse ut fra datagrunnlaget. I et tenkt tilfelle kunne alle 20 observasjoner fra 31. juli vært registrert kl 22:01 og i så fall vil det gi et korrekt utfall at disse filtreres vekk når sommertid gjelder mens for vintertid vil det gitt feil utfall. I realiteten er klokkeslett ikke kjent og da vil den logiske operatoren som benyttes i filteret fungere som beskrevet over for POSIX-klassene, altså at alle opersjonsdatoer som er lik <em>datoTil</em> men som ligger “øst” for UTC filtreres ut.</p>
</div>
<div id="og-hvorfor-ender-man-opp-med-datoer-fra-ulike-tidssoner" class="section level2">
<h2 class="hasAnchor">
<a href="#og-hvorfor-ender-man-opp-med-datoer-fra-ulike-tidssoner" class="anchor"></a>Og hvorfor ender man opp med datoer fra ulike tidssoner?</h2>
<p>For verdiene i <em>OperasjonsDato</em> er svaret allerede gitt over. Ved konvertering fra klassen <a href="http://stat.ethz.ch/R-manual/R-devel/library/base/html/Dates.html"><em>Date</em></a> til klassen <a href="https://stat.ethz.ch/R-manual/R-devel/library/base/html/DateTimeClasses.html"><em>POSIXlt</em></a> så er ikke tidssone definert og det benyttes da default tidssone UTC. Ved konvertering av <em>datoTil</em> fra klassen <a href="https://stat.ethz.ch/R-manual/R-devel/library/base/html/character.html"><em>character</em></a> til klassen <a href="https://stat.ethz.ch/R-manual/R-devel/library/base/html/DateTimeClasses.html"><em>POSIXlt</em></a> spør funksjonen <a href="https://stat.ethz.ch/R-manual/R-devel/library/base/html/as.POSIXlt.html"><em>as.POSIXlt</em></a> egen server hvilken tidssone den befinner seg i. I eksempelet over fikk funksjonen svaret “CEST” (UTC+2). Den samme funksjonen ville gitt “CET” (UTC+1) om den ble kjørt i desember. Bruk av klassen <a href="https://stat.ethz.ch/R-manual/R-devel/library/base/html/DateTimeClasses.html"><em>POSIXct</em></a> ville gitt samme resultat. En digresjon angående disse klassene er at “ct” (calendar time) forholder seg til antall sekunder fra et gitt tidspunkt (the epoch, <em>i.e.</em> 1970-01-01 UTC) mens “lt” (local time) inneholder en liste med vektorer som hver angir år, måned, dag, time, osv.</p>
</div>
<div id="mulige-lsninger" class="section level2">
<h2 class="hasAnchor">
<a href="#mulige-lsninger" class="anchor"></a>Mulige løsninger</h2>
<p>I eksempelet over introduseres feilen ved bruk av POSIX-klassene og den påfølgende bruken av tidssoner. Selv om det ikke kan utelukkes helt så vil praktisk håndtering av data fra norske kvalitetsregistre ikke ha behov for bruk av tidssone. I så måte kunne man unngått bruk av disse klassene for datoer. Men, det kan finnes mange gode grunner til å fortsette bruken og da foreutsetter det at man håndterer tidssoner riktig. I eksempelet over kunne man tatt vekk datofilteret i R-koden da det allerede er definert i sql (spørringen til databasen). Om man likevel ønkser å ivareta et slik filter i R-koden ved bruk av <a href="https://stat.ethz.ch/R-manual/R-devel/library/base/html/DateTimeClasses.html"><em>POSIX</em></a> kan dette gjøre gjennom å definere samme tidssone eksplisitt for alle variabler:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">RegData<span class="op">$</span>OperasjonsDato &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.POSIXlt">as.POSIXlt</a></span>(RegData<span class="op">$</span>OpDato, <span class="dt">tz=</span><span class="st">"UTC"</span>, <span class="dt">format=</span><span class="st">"%Y-%m-%d"</span>)
...
indDato &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/which">which</a></span>(RegData<span class="op">$</span>OperasjonsDato <span class="op">&lt;=</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.POSIXlt">as.POSIXlt</a></span>(datoTil, <span class="dt">tz=</span><span class="st">"UTC"</span>))</code></pre></div>
<p>Definisjon av tidssone i den første linja er strengt tatt ikke nødvendig da UTC vil være default i dette eksempelet. Men (OBS, OBS), om datoformatet i databasen hadde vært et annet så kunne det likevel være nødvendig å håndtere tidssone eksplisitt. Se under.</p>
</div>
<div id="dato-og-tidsformater-i-mysql-og-ikke-mssql" class="section level2">
<h2 class="hasAnchor">
<a href="#dato-og-tidsformater-i-mysql-og-ikke-mssql" class="anchor"></a>Dato og tidsformater i MySQL (og ikke MSSQL)</h2>
<p>MySQL (den mest vanlige databasemotoren på <em>Rapporteket</em>) benytter tre ulike tidsformater: DATE, DATETIME og TIMESTAMP. De to første definerer ikke tidssone mens den siste gjør det. Felter med format TIMESTAMP vil gjennom <a href="https://cran.r-project.org/web/packages/DBI/index.html"><em>DBI</em></a> være definert som klassen <a href="https://stat.ethz.ch/R-manual/R-devel/library/base/html/DateTimeClasses.html"><em>POSIXct</em></a> og dermed ivareta tidssone når verdiene representeres i R. Den tekniske manualen for MySQL gir <a href="https://dev.mysql.com/doc/refman/5.5/en/datetime.html">flere detaljer</a> som er vel verdt å lese. Rapportutviklere som benytter data fra en database (gjennom sql) bør derfor være oppmerksom på de formater som benyttes i databasen når spørringen settes opp for å sikre at videre tallbehandling i R gjøres riktig.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#problembeskrivelse">Problembeskrivelse</a></li>
      <li><a href="#eksempel-pa-feil-som-oppstar">Eksempel på feil som oppstår</a></li>
      <li><a href="#og-hvorfor-ender-man-opp-med-datoer-fra-ulike-tidssoner">Og hvorfor ender man opp med datoer fra ulike tidssoner?</a></li>
      <li><a href="#mulige-lsninger">Mulige løsninger</a></li>
      <li><a href="#dato-og-tidsformater-i-mysql-og-ikke-mssql">Dato og tidsformater i MySQL (og ikke MSSQL)</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Edvardsen Are, Thon Kevin.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
